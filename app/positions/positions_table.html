{% extends "base.html" %}

{% block title %}Positions Table{% endblock %}

{% block extra_styles %}
{{ super() }}
<style>
  /* Positions Table Dynamic Styles */
  .grid-header, .grid-row, .grid-totals {
    display: flex;
    padding: 0.5rem;
    transition: background-color 0.5s, color 0.5s;
  }
  .grid-header {
    background-color: var(--card-title-color, #343a40);
    color: var(--text-color, #ffffff);
    font-weight: bold;
  }
  .grid-row, .grid-totals {
    color: var(--text-color, #000000);
  }
  .grid-row {
    border-bottom: 1px solid var(--border-color, #ddd);
  }
  .grid-totals {
    background-color: var(--card-background-color, #e9ecef);
    font-weight: bold;
  }
  .grid-col {
    flex: 1;
    text-align: center;
    padding: 0.5rem;
  }
  .grid-col.asset {
    flex: 0 0 10%;
    max-width: 10%;
  }
  .sortable {
    cursor: pointer;
  }
  .asset-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
  }
  .title-text {
    color: var(--title-text-color, darkblue);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
  <div class="card">
    <div class="card-body">
      <h2 class="title-text mb-4">Positions</h2>

      <!-- Header -->
      <div class="grid-header">
        <div class="grid-col asset sortable" data-col-index="0">Asset</div>
        <div class="grid-col sortable" data-col-index="1">Profit</div>
        <div class="grid-col sortable" data-col-index="2">Heat Index</div>
        <div class="grid-col sortable" data-col-index="3">Collateral</div>
        <div class="grid-col sortable" data-col-index="4">Value</div>
        <div class="grid-col sortable" data-col-index="5">Size</div>
        <div class="grid-col sortable" data-col-index="6">Leverage</div>
        <div class="grid-col sortable" data-col-index="7">Travel %</div>
      </div>

      <!-- Data -->
      <div id="gridRows">
        {% for pos in positions|sort(attribute='size', reverse=True) %}
        <div class="grid-row">
          <div class="grid-col asset">
            {% if pos.asset_type == 'BTC' %}
              <img src="{{ url_for('static', filename='images/btc_logo.png') }}" alt="BTC" class="asset-icon">
            {% elif pos.asset_type == 'ETH' %}
              <img src="{{ url_for('static', filename='images/eth_logo.png') }}" alt="ETH" class="asset-icon">
            {% elif pos.asset_type == 'SOL' %}
              <img src="{{ url_for('static', filename='images/sol_logo.png') }}" alt="SOL" class="asset-icon">
            {% else %}
              {{ pos.asset_type }}
            {% endif %}
          </div>
          <div class="grid-col">{{ "{:,.2f}".format(pos.pnl_after_fees_usd or 0) }}</div>
          <div class="grid-col">{{ "{:,.2f}".format(pos.heat_index or 0) }}</div>
          <div class="grid-col">{{ "{:,.2f}".format(pos.collateral or 0) }}</div>
          <div class="grid-col">{{ "{:,.2f}".format(pos.value or 0) }}</div>
          <div class="grid-col">{{ "{:,.2f}".format(pos.size or 0) }}</div>
          <div class="grid-col">{{ "{:,.2f}".format(pos.leverage or 0) }}</div>
          <div class="grid-col">{{ "{:,.2f}".format(pos.travel_percent or 0) }}%</div>
        </div>
        {% endfor %}
      </div>

      <!-- Totals -->
      {% set total_profit = positions|sum(attribute='pnl_after_fees_usd') %}
      <div class="grid-totals">
        <div class="grid-col asset">Totals</div>
        <div class="grid-col">{{ "{:,.2f}".format(total_profit) }}</div>
        <div class="grid-col">{{ "{:,.2f}".format(totals.avg_heat_index or 0) }}</div>
        <div class="grid-col">{{ "{:,.2f}".format(totals.total_collateral or 0) }}</div>
        <div class="grid-col">{{ "{:,.2f}".format(totals.total_value or 0) }}</div>
        <div class="grid-col">{{ "{:,.2f}".format(totals.total_size or 0) }}</div>
        <div class="grid-col">{{ "{:,.2f}".format(totals.avg_leverage or 0) }}</div>
        <div class="grid-col">{{ "{:,.2f}".format(totals.avg_travel_percent or 0) }}%</div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
  // Grid Sorting
  document.addEventListener("DOMContentLoaded", function() {
    const headerCells = document.querySelectorAll(".grid-header .sortable");
    const gridRowsContainer = document.getElementById("gridRows");

    headerCells.forEach(cell => {
      cell.addEventListener("click", function() {
        const colIndex = parseInt(cell.getAttribute("data-col-index"));
        const rows = Array.from(gridRowsContainer.getElementsByClassName("grid-row"));
        const currentDirection = cell.getAttribute("data-sort-direction") || "asc";
        const newDirection = currentDirection === "asc" ? "desc" : "asc";
        cell.setAttribute("data-sort-direction", newDirection);

        rows.sort((a, b) => {
          const aVal = a.getElementsByClassName("grid-col")[colIndex].innerText.trim();
          const bVal = b.getElementsByClassName("grid-col")[colIndex].innerText.trim();
          const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, "")) || 0;
          const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, "")) || 0;
          return newDirection === "asc" ? aNum - bNum : bNum - aNum;
        });

        rows.forEach(row => gridRowsContainer.appendChild(row));
      });
    });
  });
</script>
{% endblock %}
