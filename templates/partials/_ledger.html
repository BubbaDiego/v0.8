<!-- _ledger.html -->

<link rel="stylesheet" href="../../static/css/dashboard.css">

<div class="common-box light-mode d-flex justify-content-center flex-wrap">

  <div id="priceBox" class="ledger-box common-box light-mode mx-2 my-2">
  <div class="icon">ğŸ’µ</div>
  <small id="priceLast">Last: 9:30 AM</small>
  <small id="priceCountdown">Next in: 2m 30s</small>
</div>

<div id="positionBox" class="ledger-box common-box light-mode mx-2 my-2">
  <div class="icon">ğŸ“Š</div>
  <small id="positionLast">Last: 9:25 AM</small>
  <small id="positionCountdown">Next in: 1m 30s</small>
</div>

<div id="cycloneBox" class="ledger-box common-box light-mode mx-2 my-2">
  <div class="icon">ğŸŒªï¸</div>
  <small id="cycloneLast">Last: 8:55 AM</small>
  <small id="cycloneCountdown">Next in: 0m 30s</small>
</div>


</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

  function applyFreshnessVisuals(boxId, iconId, ageSeconds) {
    const box = document.getElementById(boxId);
    const icon = document.getElementById(iconId);

    if (!box || !icon) return;

    box.classList.remove('fresh-pulse', 'warning-pulse', 'stale-pulse', 'fresh-gradient', 'warning-gradient', 'stale-gradient');
    icon.classList.remove('text-success', 'text-warning', 'text-danger');

    if (ageSeconds < 5) {
      box.classList.add('fresh-pulse', 'fresh-gradient');
      icon.textContent = 'âœ…';
      icon.classList.add('text-success');
    } else if (ageSeconds < 10) {
      box.classList.add('warning-pulse', 'warning-gradient');
      icon.textContent = 'âš ï¸';
      icon.classList.add('text-warning');
    } else {
      box.classList.add('stale-pulse', 'stale-gradient');
      icon.textContent = 'ğŸ”¥';
      icon.classList.add('text-danger');
    }
  }


  function refreshFreshness() {
    fetch('/api/ledger_ages')  // <-- new small API we build next
      .then(response => response.json())
      .then(data => {
        document.getElementById('priceAge').textContent = data.age_price;
        document.getElementById('positionAge').textContent = data.age_positions;
        document.getElementById('cycloneAge').textContent = data.age_cyclone;

        applyFreshnessVisuals('priceBox', 'priceIcon', parseInt(data.age_price));
        applyFreshnessVisuals('positionBox', 'positionIcon', parseInt(data.age_positions));
        applyFreshnessVisuals('cycloneBox', 'cycloneIcon', parseInt(data.age_cyclone));
      })
      .catch(err => console.error('Error refreshing freshness:', err));
  }

  // First initial call
  refreshFreshness();

  // Refresh every 60 seconds
  setInterval(refreshFreshness, 60000);

});
</script>
