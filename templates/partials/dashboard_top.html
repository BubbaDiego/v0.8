<link rel="stylesheet" href="../../static/css/dashboard_top.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_top.css') }}">

<div class="dashboard-top-wrapper">
  <!-- Portfolio Section -->
  <div class="dashboard-section">
    <h5 class="section-title">Portfolio</h5>
    <div class="card-flex">
      {% set alias_map = {
        "value": "total_value",
        "leverage": "avg_leverage",
        "size": "total_size",
        "ratio": "value_to_collateral_ratio",
        "travel": "avg_travel_percent",
        "heat": "total_heat",
        "price": "price",
        "positions": "positions",
        "operations": "operations",
        "xcom": "xcom"
      } %}
      {% set available_keys = portfolio_limits.keys() %}
      {% for item in status_items %}
        {% set raw = item.title.lower().replace(' ', '_') %}
        {% set key = alias_map.get(raw, raw) %}
        {% set thresholds = portfolio_limits.get(key) %}
        <div class="flip-card">
          <div class="flip-card-inner">
            <div class="flip-card-front status-card {{ item.color }}">
              <div class="icon">{{ item.icon }}</div>
              <div class="value">{{ item.value }}</div>
              <div class="label">{{ item.title }}</div>
            </div>
            <div class="flip-card-back">
              {% if thresholds %}
                <div class="thresholds">
                  <div><span class="dot green"></span> Low: {{ thresholds.low }}</div>
                  <div><span class="dot yellow"></span> Med: {{ thresholds.medium }}</div>
                  <div><span class="dot red"></span> High: {{ thresholds.high }}</div>
                </div>
              {% else %}
                <div class="text-muted">‚ùå No thresholds for <code>{{ key }}</code></div>
                <div class="text-muted">Available keys: {{ available_keys | join(', ') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Monitor Section -->
  <div class="dashboard-section">
    <h5 class="section-title">Monitor</h5>
    <div class="card-flex">
      {% for item in monitor_items %}
        {% set raw = item.title.lower().replace(' ', '_') %}
        {% set key = alias_map.get(raw, raw) %}
        {% set thresholds = portfolio_limits.get(key) %}
        <div class="flip-card">
          <div class="flip-card-inner">
            <div class="flip-card-front status-card monitor-style {{ item.color }}">
              <div class="icon">{{ item.icon }}</div>
              <div class="value">{{ item.value }}</div>
              <div class="label">{{ item.title }}</div>
              <div class="led-dot {{ item.color }}"></div>
            </div>
            <div class="flip-card-back">
              {% if item.title == "Price" %}
                <div>
                  <strong>Status:</strong>
                  {% if item.color == 'green' %}
                    <span class="text-success" style="font-size:1.2em;">‚úÖ</span>
                  {% elif item.color == 'yellow' %}
                    <span class="text-warning" style="font-size:1.2em;">‚ö†Ô∏è</span>
                  {% else %}
                    <span class="text-danger" style="font-size:1.2em;">‚ùå</span>
                  {% endif %}
                </div>
                <div>
                  <ul class="mini-list mt-07">
                    {% for asset in price_monitor_history %}
                      <li class="mb-07">
                        {{ asset.icon }} <span class="text-bold">{{ asset.label }}:</span>
                        {% if asset.show_cents %}
                          ${{ '{:,.2f}'.format(asset.value) }}
                        {% else %}
                          ${{ '{:,.0f}'.format(asset.value) }}
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% elif item.title == "Positions" %}
                <div>
                  <ul class="mini-list mt-07">
                    {% for sync in positions_monitor_history %}
                      <li class="mb-07">
                        <span style="font-size:1.2em;">
                          {% if sync.source == "Manual" %}
                            üë§
                          {% else %}
                            üñ•Ô∏è
                          {% endif %}
                        </span>
                        <span style="color:#666; font-size:0.95em;">({{ sync.timestamp }})</span>
                        <br>
                        <span style="color:#2b8a3e;">+{{ sync.imported }}</span>
                        {% if sync.skipped %}
                          <span style="color:#ffaa1a;">Skipped: {{ sync.skipped }}</span>
                        {% endif %}
                        {% if sync.errors %}
                          <span style="color:#d72d36;">Errors: {{ sync.errors }}</span>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% elif item.title == "Operations" %}
                <div>
                  <ul class="mini-list mt-07">
                    {% for op in operations_monitor_history %}
                      <li class="mb-07">
                        {% if op.post_success %}
                          <span class="text-success" style="font-size:1.15em;">‚úÖ</span>
                        {% else %}
                          <span class="text-danger" style="font-size:1.15em;">‚ùå</span>
                        {% endif %}
                        <span style="color:#666; font-size:0.96em;">({{ op.timestamp }})</span>
                        <br>
                        <span style="color:#666;">Duration: {{ '%.1f'|format(op.duration_seconds) }}s</span>
                        {% if op.error %}
                          <br><span style="color:#d72d36;">Error: {{ op.error }}</span>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% elif thresholds %}
                <div class="thresholds">
                  <div><span class="dot green"></span> Low: {{ thresholds.low }}</div>
                  <div><span class="dot yellow"></span> Med: {{ thresholds.medium }}</div>
                  <div><span class="dot red"></span> High: {{ thresholds.high }}</div>
                </div>
              {% else %}
                <div class="text-muted">‚ùå No thresholds for <code>{{ key }}</code></div>
                <div class="text-muted">Available keys: {{ available_keys | join(', ') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
