{% extends "base.html" %}
{% block title %}Alert Monitor{% endblock %}

{% block extra_styles %}
<style>
  body {
    background-color: #f5f6fa;
  }

  .table-container {
    background: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 14px rgba(0, 0, 0, 0.08);
  }

  table thead th {
    background-color: #212529;
    color: #ffffff;
    font-weight: 600;
    font-size: 0.85rem;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  table tbody td {
    vertical-align: middle;
    font-size: 0.875rem;
  }

  tbody tr:hover {
    background-color: #f2f4f6;
  }

  tbody tr {
    border-bottom: 1px solid #e3e3e3;
  }

  .badge {
    font-size: 0.7rem;
    padding: 0.35em 0.65em;
    border-radius: 6px;
  }

  .badge-level-High {
    background-color: #dc3545;
    color: #fff;
  }

  .badge-level-Medium {
    background-color: #ffc107;
    color: #212529;
  }

  .badge-level-Low {
    background-color: #0d6efd;
    color: #fff;
  }

  .badge-status-Active {
    background-color: #198754;
    color: #fff;
  }

  .badge-status-Inactive {
    background-color: #6c757d;
    color: #fff;
  }

  .alert-img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #ccc;
  }

  .refresh-spin {
    animation: spin 1s linear infinite;
  }

  .click-sortable {
    cursor: pointer;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4"><i class="fas fa-bell"></i> Alert Monitor</h2>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <button id="manualRefreshBtn" class="btn btn-outline-primary btn-sm">
      <i id="refreshIcon" class="fas fa-sync-alt"></i> Refresh
    </button>
    <div>
      <label class="form-label me-2 mb-0">Filter by Level:</label>
      <select id="levelFilter" class="form-select form-select-sm d-inline-block w-auto">
        <option value="">All</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
        <option value="Normal">Normal</option>
      </select>
    </div>
  </div>

  <div class="table-container">
    <table id="alertTable" class="table table-hover align-middle mb-0">
      <thead>
        <tr>
          <th class="click-sortable" data-key="asset">Asset</th>
          <th>Asset Img</th>
          <th>Wallet Img</th>
          <th class="click-sortable" data-key="alert_class">Class</th>
          <th class="click-sortable" data-key="alert_type">Type</th>
          <th class="click-sortable" data-key="trigger_value">Trigger</th>
          <th class="click-sortable" data-key="evaluated_value">Evaluated</th>
          <th class="click-sortable" data-key="level">Level</th>
          <th class="click-sortable" data-key="status">Status</th>
          <th class="click-sortable" data-key="last_triggered">Last Triggered</th>
          <th class="click-sortable" data-key="id">ID</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  let alertData = [];
  let sortKey = 'last_triggered';
  let sortDirection = 'desc';

  function getSafeLevel(levelRaw) {
    if (!levelRaw) return "Normal";
    const match = String(levelRaw).match(/(High|Medium|Low|Normal)/i);
    return match ? match[0] : "Normal";
  }

  function getSafeStatus(statusRaw) {
    return (typeof statusRaw === "string" && ["Active", "Inactive"].includes(statusRaw)) ? statusRaw : "Inactive";
  }

  function getAlertTypeIcon(type) {
    const map = {
      HeatIndex: "fa-fire",
      Profit: "fa-sack-dollar",
      TravelPercentLiquid: "fa-plane-departure",
      ValueToCollateralRatio: "fa-balance-scale",
      TotalValue: "fa-chart-bar",
      AvgLeverage: "fa-wrench"
    };
    return map[type] || "fa-bell";
  }

  async function fetchAlerts() {
    const icon = document.getElementById("refreshIcon");
    icon.classList.add("refresh-spin");
    try {
      const res = await fetch("/alerts/monitor");
      const json = await res.json();
      alertData = json.alerts || [];
      renderTable();
    } catch (err) {
      console.error("Error fetching alerts:", err);
    } finally {
      setTimeout(() => icon.classList.remove("refresh-spin"), 700);
    }
  }

  function renderTable() {
    const tbody = document.querySelector("#alertTable tbody");
    const filterLevel = document.getElementById("levelFilter").value;
    tbody.innerHTML = "";

    const filtered = alertData.filter(a => !filterLevel || getSafeLevel(a.level) === filterLevel);

    filtered.sort((a, b) => {
      const valA = a[sortKey] ?? '';
      const valB = b[sortKey] ?? '';
      return sortDirection === 'asc'
        ? String(valA).localeCompare(String(valB))
        : String(valB).localeCompare(String(valA));
    });

    filtered.forEach(alert => {
      const level = getSafeLevel(alert.level);
      const status = getSafeStatus(alert.status);
      const asset = alert.asset ?? "—";
      const wallet = alert.wallet_name ?? "—";
      const assetImg = alert.asset_image ?? `/static/images/${asset.toLowerCase()}_logo.png`;
      const walletImg = alert.wallet_image ?? `/static/images/${wallet.toLowerCase()}.jpg`;
      const shortId = String(alert.id).substring(0, 5);
      const time = alert.last_triggered ? new Date(alert.last_triggered).toLocaleString() : "—";

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${asset}</td>
        <td><img src="${assetImg}" class="alert-img" onerror="this.src='/static/images/unknown.png'"></td>
        <td><img src="${walletImg}" class="alert-img" onerror="this.src='/static/images/unknown_wallet.jpg'"></td>
        <td>${alert.alert_class}</td>
        <td title="${alert.alert_type}">
          <i class="fas ${getAlertTypeIcon(alert.alert_type)} text-secondary me-1"></i>
        </td>
        <td>${alert.trigger_value ?? "—"}</td>
        <td>${alert.evaluated_value ?? "—"}</td>
        <td><span class="badge badge-level-${level}">${level}</span></td>
        <td><span class="badge badge-status-${status}">${status}</span></td>
        <td>${time}</td>
        <td title="${alert.id}">${shortId}</td>
      `;
      tbody.appendChild(row);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    fetchAlerts();
    setInterval(fetchAlerts, 10000);
    document.getElementById("manualRefreshBtn").addEventListener("click", fetchAlerts);
    document.getElementById("levelFilter").addEventListener("change", renderTable);
    document.querySelectorAll(".click-sortable").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.dataset.key;
        sortDirection = (sortKey === key && sortDirection === 'asc') ? 'desc' : 'asc';
        sortKey = key;
        renderTable();
      });
    });
  });
</script>
{% endblock %}
