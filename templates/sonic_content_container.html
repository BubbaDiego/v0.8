<div class="sonic-section-container">
  <div class="sonic-panel-body">

    <!-- üîπ Portfolio Panel -->
    <div class="sonic-dashboard-panel small sonic-dashboard-panel portfolio">
      <div class="sonic-panel-header">
        <h5 class="panel-title">Portfolio</h5>
      </div>
      <div class="card-flex">
        {% set alias_map = {
          "value": "total_value",
          "leverage": "avg_leverage",
          "size": "total_size",
          "ratio": "value_to_collateral_ratio",
          "travel": "avg_travel_percent",
          "heat": "total_heat",
          "price": "price",
          "positions": "positions",
          "operations": "operations",
          "xcom": "xcom"
        } %}
        {% set available_keys = portfolio_limits.keys() %}
        {% for item in status_items %}
          {% set raw = item.title.lower().replace(' ', '_') %}
          {% set key = alias_map.get(raw, raw) %}
          {% set thresholds = portfolio_limits.get(key) %}
          <div class="flip-card">
            <div class="flip-card-inner">
              <div class="flip-card-front status-card {{ item.color }}">
                <div class="icon">{{ item.icon }}</div>
                <div class="value">{{ item.value }}</div>
                <div class="label">{{ item.title }}</div>
              </div>
              <div class="flip-card-back">
                {% if thresholds %}
                  <div class="thresholds">
                    <div><span class="dot green"></span> Low: {{ thresholds.low }}</div>
                    <div><span class="dot yellow"></span> Med: {{ thresholds.medium }}</div>
                    <div><span class="dot red"></span> High: {{ thresholds.high }}</div>
                  </div>
                {% else %}
                  <div class="text-muted">‚ùå No thresholds for <code>{{ key }}</code></div>
                  <div class="text-muted">Available keys: {{ available_keys | join(', ') }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- üîπ Monitor Panel -->
    <div class="sonic-dashboard-panel small sonic-dashboard-panel monitor">
      <div class="sonic-panel-header">
        <h5 class="panel-title">Monitor</h5>
      </div>
      <div class="card-flex">
        {% for item in monitor_items %}
          {% set raw = item.title.lower().replace(' ', '_') %}
          {% set key = alias_map.get(raw, raw) %}
          {% set thresholds = portfolio_limits.get(key) %}
          <div class="flip-card">
            <div class="flip-card-inner">
              <div class="flip-card-front status-card monitor-style {{ item.color }}">
                <div class="icon">{{ item.icon }}</div>
                <div class="value">{{ item.value }}</div>
                <div class="label">{{ item.title }}</div>
                <div class="led-dot {{ item.color }}"></div>
              </div>
              <div class="flip-card-back">
                {% if item.title == "Price" %}
                  <strong>Status:</strong>
                  <span class="{% if item.color == 'green' %}text-success{% elif item.color == 'yellow' %}text-warning{% else %}text-danger{% endif %}" style="font-size:1.2em;">
                    {% if item.color == 'green' %}‚úÖ{% elif item.color == 'yellow' %}‚ö†Ô∏è{% else %}‚ùå{% endif %}
                  </span>
                  <ul class="mini-list mt-07">
                    {% for asset in price_monitor_history %}
                      <li class="mb-07">
                        {{ asset.icon }} <span class="text-bold">{{ asset.label }}:</span>
                        {% if asset.show_cents %}
                          ${{ '{:,.2f}'.format(asset.value) }}
                        {% else %}
                          ${{ '{:,.0f}'.format(asset.value) }}
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% elif item.title == "Positions" %}
                  <ul class="mini-list mt-07">
                    {% for sync in positions_monitor_history %}
                      <li class="mb-07">
                        <span style="font-size:1.2em;">{{ "üë§" if sync.source == "Manual" else "üñ•Ô∏è" }}</span>
                        <span class="text-muted small">({{ sync.timestamp }})</span><br>
                        <span style="color:#2b8a3e;">+{{ sync.imported }}</span>
                        {% if sync.skipped %} <span style="color:#ffaa1a;">Skipped: {{ sync.skipped }}</span> {% endif %}
                        {% if sync.errors %} <span style="color:#d72d36;">Errors: {{ sync.errors }}</span> {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% elif item.title == "Operations" %}
                  <ul class="mini-list mt-07">
                    {% for op in operations_monitor_history %}
                      <li class="mb-07">
                        <span class="{% if op.post_success %}text-success{% else %}text-danger{% endif %}" style="font-size:1.15em;">
                          {% if op.post_success %}‚úÖ{% else %}‚ùå{% endif %}
                        </span>
                        <span class="text-muted small">({{ op.timestamp }})</span><br>
                        <span class="text-muted">Duration: {{ '%.1f'|format(op.duration_seconds) }}s</span>
                        {% if op.error %}
                          <br><span style="color:#d72d36;">Error: {{ op.error }}</span>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% elif thresholds %}
                  <div class="thresholds">
                    <div><span class="dot green"></span> Low: {{ thresholds.low }}</div>
                    <div><span class="dot yellow"></span> Med: {{ thresholds.medium }}</div>
                    <div><span class="dot red"></span> High: {{ thresholds.high }}</div>
                  </div>
                {% else %}
                  <div class="text-muted">‚ùå No thresholds for <code>{{ key }}</code></div>
                  <div class="text-muted">Available keys: {{ available_keys | join(', ') }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  </div>
</div>
