{% extends "base.html" %}

{% block head %}
<script src="{{ url_for('static', filename='js/api_routes.js') }}"></script>
{% endblock %}

{% block title %}Alert Limits Configuration{% endblock %}

{% block extra_styles %}
{{ super() }}
<style>
  .save-spinner {
    display: none;
    width: 1.5rem;
    height: 1.5rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid pt-4">

<form id="alertForm" method="POST" action="{{ url_for('alerts_bp.update_config') }}">


<!-- 📈 Price Alerts -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <i class="fas fa-dollar-sign me-2"></i>Price Alerts
  </div>
  <div class="card-body">
    <div class="row">
      {% for asset in ["BTC", "ETH", "SOL"] %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 text-center shadow-sm">
          <div class="card-body">
            {% if asset == "BTC" %}
              <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.svg?v=023" style="width:40px;">
            {% elif asset == "ETH" %}
              <img src="https://cryptologos.cc/logos/ethereum-eth-logo.svg?v=023" style="width:40px;">
            {% elif asset == "SOL" %}
              <img src="https://cryptologos.cc/logos/solana-sol-logo.svg?v=023" style="width:40px;">
{% endif %}
            <h4 class="mt-2">{{ asset }}</h4>

            <label class="form-label mt-3">Trigger Value:</label>
            <input type="number" step="0.01" class="form-control"
                   name="alert_ranges[price_alerts][{{ asset }}][trigger_value]"
                   value="{{ price_alerts[asset].trigger_value if price_alerts[asset] else '' }}">

            <label class="form-label mt-3">Condition:</label>
            <select class="form-select" name="alert_ranges[price_alerts][{{ asset }}][condition]">
              <option value="ABOVE" {% if price_alerts[asset].condition == 'ABOVE' %}selected{% endif %}>Above</option>
              <option value="BELOW" {% if price_alerts[asset].condition == 'BELOW' %}selected{% endif %}>Below</option>
            </select>

            <div class="form-check form-switch mt-3">
              <input type="hidden" name="alert_ranges[price_alerts][{{ asset }}][enabled]" value="false">
              <input type="checkbox" class="form-check-input"
                     name="alert_ranges[price_alerts][{{ asset }}][enabled]" value="true"
                     {% if price_alerts[asset].enabled %}checked{% endif %}>
              <label class="form-check-label">Enabled</label>
            </div>

          </div>
        </div>
      </div>
{% endfor %}
    </div>
  </div>
</div>

<!-- 🌐 Global Alerts -->
<div class="card mb-4">
  <div class="card-header bg-info text-white">
    <i class="fas fa-globe me-2"></i>Global Alerts
  </div>
  <div class="card-body">
    <div class="form-check form-switch mb-4">
      <input type="hidden" name="global_alert_config[enabled]" value="false">
      <input type="checkbox" class="form-check-input"
             name="global_alert_config[enabled]" value="true"
             {% if global_alert_config.enabled %}checked{% endif %}>
      <label class="form-check-label">Enable Global Alerts</label>
    </div>

    <div class="row mb-4">
      <div class="col-12">
        <label class="form-label">Monitor Fields:</label>
        <div class="d-flex flex-wrap gap-3">
          {% for field in ["price", "profit", "travel_percent", "heat_index"] %}
          <div class="form-check">
            <input type="hidden" name="global_alert_config[data_fields][{{ field }}]" value="false">
            <input type="checkbox" class="form-check-input"
                   name="global_alert_config[data_fields][{{ field }}]" value="true"
                   {% if global_alert_config.data_fields[field] %}checked{% endif %}>
            <label class="form-check-label text-capitalize">{{ field.replace('_',' ') }}</label>
          </div>
{% endfor %}
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4">
        <label class="form-label">Profit Threshold</label>
        <input type="number" step="0.01" class="form-control" name="global_alert_config[thresholds][profit]"
               value="{{ global_alert_config.thresholds.profit }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Travel Threshold</label>
        <input type="number" step="0.01" class="form-control" name="global_alert_config[thresholds][travel_percent]"
               value="{{ global_alert_config.thresholds.travel_percent }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Heat Index Threshold</label>
        <input type="number" step="0.01" class="form-control" name="global_alert_config[thresholds][heat_index]"
               value="{{ global_alert_config.thresholds.heat_index }}">
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-12">
        <label class="form-label">Price Thresholds per Asset:</label>
        <div class="row g-2">
          {% for asset in ["BTC", "ETH", "SOL"] %}
          <div class="col-md-4">
            <label class="form-label">{{ asset }}</label>
            <input type="number" step="0.01" class="form-control"
                   name="global_alert_config[thresholds][price][{{ asset }}]"
                   value="{{ global_alert_config.thresholds.price[asset] }}">
          </div>
{% endfor %}
        </div>
      </div>
    </div>

  </div>
</div>

<div class="d-flex justify-content-end mt-3">
  <button type="submit" class="btn btn-primary">
    Save
    <span class="save-spinner"></span>
  </button>
</div>

</form>
</div>
{% endblock %}
