{% extends "base.html" %}
{% block title %}Alert Monitor{% endblock %}

{% block extra_styles %}
<style>
  body {
    background-color: #f5f6fa;
  }

  .table-container {
    background: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 14px rgba(0, 0, 0, 0.08);
  }

  table thead th {
    background-color: #212529;
    color: #ffffff;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 0.75rem 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    text-align: center;
  }

  table tbody td {
    font-size: 0.875rem;
    text-align: center;
    vertical-align: middle !important;
  }

  tbody tr:hover {
    background-color: #f2f4f6;
  }

  .alert-img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #ccc;
  }

  .icon-label {
    display: inline-block;
    height: 28px;
    line-height: 28px;
    font-size: 1.4rem;
    text-align: center;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
  }

  .badge {
    font-size: 0.7rem;
    padding: 0.35em 0.65em;
    border-radius: 6px;
  }

  .badge-level-Normal {
    background-color: #6c757d;
    color: #fff;
  }

  .badge-status-Active {
    background-color: #198754;
    color: #fff;
  }

  .badge-status-Inactive {
    background-color: #6c757d;
    color: #fff;
  }

  .bar-container {
    position: relative;
    height: 14px;
    background: #e9ecef;
    border-radius: 6px;
    margin-top: 8px;
    width: 100%;
    max-width: 420px;
    margin-inline: auto;
  }

  .bar-fill {
    position: absolute;
    height: 100%;
    background: repeating-linear-gradient(45deg, #0d6efd, #0d6efd 6px, #0a58ca 6px, #0a58ca 12px);
    border-radius: 6px;
    top: 0;
  }

  .bar-midline {
    position: absolute;
    left: 50%;
    top: -2px;
    width: 2px;
    height: 18px;
    background-color: #6c757d;
    z-index: 1;
  }

  .bar-bell {
    position: absolute;
    top: 32px;
    right: 0;
    font-size: 16px;
    color: #f57c00;
  }

  .refresh-spin {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4"><i class="fas fa-bell"></i> Alert Monitor</h2>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <button id="manualRefreshBtn" class="btn btn-outline-primary btn-sm">
      <i id="refreshIcon" class="fas fa-sync-alt"></i> Refresh
    </button>
    <div>
      <label class="form-label me-2 mb-0">Filter by Level:</label>
      <select id="levelFilter" class="form-select form-select-sm d-inline-block w-auto">
        <option value="">All</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
        <option value="Normal">Normal</option>
      </select>
    </div>
  </div>

  <div class="table-container">
    <table id="alertTable" class="table table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>Asset</th>
          <th>Wallet</th>
          <th>Class</th>
          <th>Type</th>
          <th>Trigger</th>
          <th>Current</th>
          <th>Status</th>
          <th>Level</th>
          <th style="width: 50%;">Progress</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  async function loadAlerts() {
    try {
      const res = await fetch("/alerts/monitor");
      const data = await res.json();
      const table = document.querySelector("#alertTable tbody");
      const levelFilter = document.getElementById("levelFilter").value;
      table.innerHTML = "";

      const alerts = data.alerts || [];

      alerts
        .filter(alert => !levelFilter || alert.level === levelFilter)
        .forEach(alert => {
          const row = document.createElement("tr");

          const start = alert.starting_value ?? 0;
          const trigger = alert.trigger_value ?? 0;
          const current = alert.evaluated_value ?? 0;
          const direction = trigger >= start ? 1 : -1;
          const range = Math.abs(trigger - start) || 1;
          const fillPercent = Math.min(Math.max((current - start) / range * 100 * direction, 0), 100);

          const assetImg = `/static/images/${(alert.asset || "unknown").toLowerCase()}_logo.png`;
          const walletImg = `/static/images/${(alert.wallet || "unknown_wallet")}.jpg`;

          row.innerHTML = `
            <td><img src="${assetImg}" class="alert-img" onerror="this.src='/static/images/unknown.png'"></td>
            <td>
              ${alert.wallet
                ? `<img src="${walletImg}" class="alert-img" onerror="this.src='/static/images/unknown_wallet.jpg'>`
                : `<span class="text-muted">‚Äî</span>`}
            </td>

            <td><span class="icon-label">${getClassIcon(alert.alert_class)}</span></td>
            <td><span class="icon-label">${getTypeIcon(alert.alert_type)}</span></td>

            <td><strong>${formatValue(alert.trigger_value)}</strong></td>
            <td><strong>${formatValue(alert.evaluated_value)}</strong></td>

            <td><span class="badge badge-status-${alert.status}">${alert.status}</span></td>
            <td><span class="badge badge-level-${alert.level}">${alert.level}</span></td>

            <td>
              <div class="bar-container">
                <div class="bar-fill" style="width: ${fillPercent}%;"></div>
                <div class="bar-midline"></div>
                <div class="bar-bell"><i class="fas fa-bell"></i></div>
              </div>
            </td>
          `;
          table.appendChild(row);
        });
    } catch (err) {
      console.error("üî• Failed to load alerts:", err);
    }
  }

  function getTypeIcon(type) {
    const map = {
      profit: "üí∞",
      heatindex: "üõ†",
      travelpercentliquid: "‚úàÔ∏è",
      pricethreshold: "üíµ"
    };
    return map[(type || "").toLowerCase()] || "‚ùì";
  }

  function getClassIcon(alertClass) {
    const map = {
      position: "üßç‚Äç‚ôÇÔ∏è",
      portfolio: "üß∫",
      market: "üìà"
    };
    return map[(alertClass || "").toLowerCase()] || "‚ùì";
  }

  function formatValue(val) {
    return (val !== null && val !== undefined) ? Number(val).toFixed(2) : "‚Äî";
  }

  document.addEventListener("DOMContentLoaded", loadAlerts);
</script>
{% endblock %}
