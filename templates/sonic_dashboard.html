{% extends "base.html" %}
{% block title %}Sonic Dashboard{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sonic_dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/title_bar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sonic_themes.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/liquidation_bars.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_middle.css') }}">

  <!-- Add any additional CSS files here -->
{% endblock %}

{% block content %}
  {% include "title_bar.html" %}
  {% include "dash_top.html" %}
  {% include "dash_middle.html" %}
  {% include "dash_bottom.html" %}

  <!-- JS: Layout Mode Toggle -->
  <script src="{{ url_for('static', filename='js/layout_mode.js') }}"></script>
  <!-- JS: Theme Toggle -->
  <script>
    const THEME_KEY = "themeMode";
    const THEMES = ["light", "dark", "funky"];
    const THEME_ICONS = ["‚òÄÔ∏è", "üåô", "üé®"];
    let themeIndex = 0;
    function applyTheme(idx) {
      const mode = THEMES[idx];
      document.documentElement.setAttribute("data-theme", mode);
      localStorage.setItem(THEME_KEY, mode);
      document.cookie = THEME_KEY + "=" + mode + ";path=/;max-age=31536000";
      const icon = document.getElementById("currentThemeIcon");
      if (icon) icon.innerText = THEME_ICONS[idx];
    }
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("themeModeToggle");
      const persisted = localStorage.getItem(THEME_KEY) || "light";
      themeIndex = THEMES.indexOf(persisted);
      if (themeIndex === -1) themeIndex = 0;
      applyTheme(themeIndex);
      if (btn) {
        btn.addEventListener("click", () => {
          themeIndex = (themeIndex + 1) % THEMES.length;
          applyTheme(themeIndex);
        });
      }
    });
  </script>
  <!-- JS: Cyclone Action Toasts -->
  <script>
    function showToast(message, type = "info") {
      const toastContainer = document.getElementById("toastContainer");
      if (!toastContainer) return;
      const toast = document.createElement("div");
      toast.className = `sonic-toast ${type}`;
      toast.innerHTML = message;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 600);
      }, 2500);
    }
    function refreshDashboardPanels() {
      window.location.reload();
    }
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".cyclone-btn").forEach(btn => {
        btn.addEventListener("click", function () {
          const action = btn.getAttribute("data-action");
          let api = null;
          let label = "";
          switch (action) {
            case "sync":   api = "/cyclone_sync"; label = "Jupiter Sync"; break;
            case "market": api = "/cyclone_market_update"; label = "Market Update"; break;
            case "full":   api = "/cyclone_full_cycle"; label = "Full Cycle"; break;
            case "wipe":   api = "/cyclone_wipe_all"; label = "Wipe All"; break;
          }
          if (!api) return;
          fetch(api, {method:"POST"}).then(resp => resp.json()).then(result => {
            if (result.success) {
              showToast(`‚úÖ ${label} complete!`, 'success');
              refreshDashboardPanels();
            } else {
              showToast(`‚ùå ${label} failed: ${result.error || result.message}`, 'error');
            }
          }).catch(err => showToast(`‚ùå ${label} failed: ${err.message}`, 'error'));
        });
      });
    });
  </script>
  <script src="{{ url_for('static', filename='js/dashboard_top.js') }}"></script>
  <script src="{{ url_for('static', filename='js/dashboard_middle.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>
    window.graphData = {{ graph_data | tojson }};
    window.sizeData = {{ size_composition | tojson }};
  </script>
  <script src="{{ url_for('static', filename='js/dashboard_bottom.js') }}"></script>
  <script src="{{ url_for('static', filename='js/size_pie.js') }}"></script>
  <script src="{{ url_for('static', filename='js/debug_outlines.js') }}"></script>
{% endblock %}
