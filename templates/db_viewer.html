{% extends "base.html" %}

{% block title %}Database Viewer{% endblock %}

{% block head %}
  <style>
    .db-table { margin-top: 1rem; }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-3">Database Viewer</h2>
  <div class="mb-3">
    <label for="tableSelect" class="form-label">Select Table:</label>
    <select id="tableSelect" class="form-select"></select>
  </div>
  <table class="table table-striped table-bordered db-table" id="dbTable">
    <thead id="tblHead"></thead>
    <tbody id="tblBody"></tbody>
  </table>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function loadTable(name) {
  const resp = await fetch(`/system/database_viewer/${name}`);
  const rows = await resp.json();
  const head = document.getElementById('tblHead');
  const body = document.getElementById('tblBody');
  head.innerHTML = '';
  body.innerHTML = '';
  if (rows.length) {
    const headerRow = document.createElement('tr');
    Object.keys(rows[0]).forEach(col => {
      const th = document.createElement('th');
      th.textContent = col;
      headerRow.appendChild(th);
    });
    head.appendChild(headerRow);
    rows.forEach(r => {
      const tr = document.createElement('tr');
      Object.values(r).forEach(val => {
        const td = document.createElement('td');
        td.textContent = val;
        tr.appendChild(td);
      });
      body.appendChild(tr);
    });
  } else {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.textContent = 'No Data';
    tr.appendChild(td);
    body.appendChild(tr);
  }
}

async function populateTables() {
  const resp = await fetch('/system/database_viewer/datasets');
  const data = await resp.json();
  const select = document.getElementById('tableSelect');
  Object.keys(data).forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });
  if (select.value) {
    loadTable(select.value);
  }
  select.addEventListener('change', () => loadTable(select.value));
}

document.addEventListener('DOMContentLoaded', populateTables);
</script>
{% endblock %}
