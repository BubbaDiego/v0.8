{% extends "base.html" %}

{% block title %}Alert Thresholds{% endblock %}

{% block page_title %}
  <h1 class="mb-4">üìè Alert Threshold Configuration</h1>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    {% for alert_class, thresholds in grouped_thresholds.items() %}
      <div class="col-md-6">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white fw-bold">
            {% if alert_class == "Portfolio" %} üì¶ Portfolio Alerts
            {% elif alert_class == "Position" %} üßç Position Alerts
            {% elif alert_class == "Market" %} üíπ Market Alerts
            {% else %} ‚öôÔ∏è {{ alert_class }} Alerts
            {% endif %}
          </div>
          <div class="card-body">
            {% for t in thresholds %}
              <div class="mb-3 border rounded shadow-sm" id="card-{{ t.id }}">
                <div class="p-2 bg-light d-flex justify-content-between align-items-center rounded-top" onclick="toggleCard('{{ t.id }}')">
                  <strong>{{ t.alert_type }} ({{ t.condition }})</strong>
                  <small>
                    Low: {{ t.low_val }}, Med: {{ t.medium_val }}, High: {{ t.high_val }}
                    {% for level in ['low', 'medium', 'high'] %}
                      {% for ch in ['SMS', 'Email', 'Voice'] %}
                        {% if ch in t[level + '_notify_list'] %}
                          <span class="badge bg-secondary ms-1">{{ ch[0] }}</span>
                        {% endif %}
                      {% endfor %}
                    {% endfor %}
                  </small>
                </div>

                <div class="expanded p-3" id="expand-{{ t.id }}" style="display: none;">
                  <form onsubmit="saveThreshold(event, '{{ t.id }}')">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr><th>Level</th><th>Value</th><th>SMS</th><th>Email</th><th>Voice</th><th>Enabled</th></tr>
                      </thead>
                      <tbody>
                        {% for level in ['low', 'medium', 'high'] %}
                          <tr>
                            <td>{{ level|capitalize }}</td>
                            <td><input name="{{ level }}" type="number" value="{{ t[level + '_val'] }}" class="form-control form-control-sm"></td>
                            {% for ch in ['SMS', 'Email', 'Voice'] %}
                              <td><input type="checkbox" name="{{ level }}_notify" value="{{ ch }}"
                                {% if ch in t[level + '_notify_list'] %} checked {% endif %}></td>
                            {% endfor %}
                            {% if loop.first %}
                              <td rowspan="3" style="vertical-align: middle;">
                                <input name="enabled" type="checkbox" {% if t.enabled %}checked{% endif %}>
                              </td>
                            {% endif %}
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    <div class="text-end">
                      <button type="submit" class="btn btn-sm btn-success">üíæ Save</button>
                      <span class="text-muted small" id="status-{{ t.id }}"></span>
                    </div>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function toggleCard(id) {
  const section = document.getElementById("expand-" + id);
  section.style.display = section.style.display === "block" ? "none" : "block";
}

function saveThreshold(e, id) {
  e.preventDefault();
  const card = document.getElementById("card-" + id);
  const form = card.querySelector("form");
  const formData = new FormData(form);
  const json = {
    low: formData.get("low"),
    medium: formData.get("medium"),
    high: formData.get("high"),
    enabled: formData.get("enabled") !== null,
    low_notify: formData.getAll("low_notify"),
    medium_notify: formData.getAll("medium_notify"),
    high_notify: formData.getAll("high_notify")
  };

  fetch(`/system/alert_thresholds/update/${id}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(json)
  })
  .then(res => res.json())
  .then(res => {
    const status = document.getElementById("status-" + id);
    if (res.success) {
      status.textContent = "‚úÖ Saved!";
      status.style.color = "green";
    } else {
      status.textContent = "‚ùå Failed: " + res.error;
      status.style.color = "red";
    }
    setTimeout(() => status.textContent = "", 3000);
  });
}
</script>
{% endblock %}
