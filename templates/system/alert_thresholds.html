{% extends "base.html" %}

{% block title %}Alert Thresholds{% endblock %}

{% block page_title %}
  <h1 class="mb-4">📏 Alert Threshold Configuration</h1>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- ⚙️ Import / Export Controls -->
  <div class="mb-3">
    <button class="btn btn-sm btn-primary" onclick="downloadThresholds()">📤 Export Thresholds</button>
    <input type="file" id="thresholdUpload" style="display:none;" onchange="uploadThresholds(this)">
    <button class="btn btn-sm btn-secondary" onclick="document.getElementById('thresholdUpload').click()">📥 Import Thresholds</button>
  </div>

  <div class="row">
    {% for alert_class, thresholds in grouped_thresholds.items() %}
      <div class="col-md-6">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white fw-bold">
            {% if alert_class == "Portfolio" %} 📦 Portfolio Alerts
            {% elif alert_class == "Position" %} 🧍 Position Alerts
            {% elif alert_class == "Market" %} 💹 Market Alerts
            {% else %} ⚙️ {{ alert_class }} Alerts
            {% endif %}
          </div>
          <div class="card-body">
            {% for t in thresholds %}
              <div class="mb-3 border rounded shadow-sm" id="card-{{ t.id }}" style="cursor: pointer;" onclick="toggleCard('{{ t.id }}')">
                <div class="p-2 bg-light rounded-top">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                      {% if t.alert_type == "AvgLeverage" %}
                        <span>⚖️</span><strong>Total Leverage</strong>
                      {% elif t.alert_type == "AvgTravelPercent" %}
                        <span>✈️</span><strong>Total Travel Percent</strong>
                      {% elif t.alert_type == "TotalHeat" %}
                        <span>🔥</span><strong>Total Heat</strong>
                      {% elif t.alert_type == "TotalValue" %}
                        <span>💰</span><strong>Total Value</strong>
                      {% elif t.alert_type == "TotalSize" %}
                        <span>📊</span><strong>Total Size</strong>
                      {% elif t.alert_type == "ValueToCollateralRatio" %}
                        <span>📐</span><strong>Total Ratio</strong>
                      {% elif t.alert_class == "Position" %}
                        <span>🔔</span><strong>{{ t.alert_type }}</strong>
                      {% else %}
                        <span>🔔</span><strong>{{ t.alert_type }}</strong>
                      {% endif %}
                    </div>
                    <small class="text-end">
                      <span style="color:green">🟢</span> Low: {{ t.low_val }},
                      <span style="color:orange">🟡</span> Med: {{ t.medium_val }},
                      <span style="color:red">🔴</span> High: {{ t.high_val }}
                    </small>
                  </div>
                </div>

                <div class="expanded p-3" id="expand-{{ t.id }}" style="display: none;">
                  <form onsubmit="saveThreshold(event, '{{ t.id }}')">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr><th>Level</th><th>Value</th><th>SMS</th><th>Email</th><th>Voice</th><th>Enabled</th></tr>
                      </thead>
                      <tbody>
                        {% for level in ['low', 'medium', 'high'] %}
                          <tr>
                            <td>{{ level|capitalize }}</td>
                            <td><input name="{{ level }}" type="number" step="any" value="{{ t[level + '_val'] }}" class="form-control form-control-sm"></td>
                            {% for ch in ['SMS', 'Email', 'Voice'] %}
                              <td><input type="checkbox" name="{{ level }}_notify" value="{{ ch }}"
                                {% if ch in t[level + '_notify_list'] %} checked {% endif %}></td>
                            {% endfor %}
                            {% if loop.first %}
                              <td rowspan="3" style="vertical-align: middle;">
                                <input name="enabled" type="checkbox" {% if t.enabled %}checked{% endif %}>
                              </td>
                            {% endif %}
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    <div class="text-end">
                      <button type="submit" class="btn btn-sm btn-success">💾 Save</button>
                      <span class="text-muted small" id="status-{{ t.id }}"></span>
                    </div>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function toggleCard(id) {
  const section = document.getElementById("expand-" + id);
  section.style.display = section.style.display === "block" ? "none" : "block";
}

function saveThreshold(e, id) {
  e.preventDefault();
  const card = document.getElementById("card-" + id);
  const form = card.querySelector("form");
  const formData = new FormData(form);
  const json = {
    low: formData.get("low"),
    medium: formData.get("medium"),
    high: formData.get("high"),
    enabled: formData.get("enabled") !== null,
    low_notify: formData.getAll("low_notify"),
    medium_notify: formData.getAll("medium_notify"),
    high_notify: formData.getAll("high_notify")
  };

  fetch(`/system/alert_thresholds/update/${id}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(json)
  })
  .then(res => res.json())
  .then(res => {
    const status = document.getElementById("status-" + id);
    if (res.success) {
      status.textContent = "✅ Saved!";
      status.style.color = "green";
    } else {
      status.textContent = "❌ Failed: " + res.error;
      status.style.color = "red";
    }
    setTimeout(() => status.textContent = "", 3000);
  });
}

function downloadThresholds() {
  fetch("/system/alert_thresholds/export")
    .then(res => res.json())
    .then(data => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "alert_thresholds.json";
      a.click();
      URL.revokeObjectURL(url);
    });
}

function uploadThresholds(input) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function () {
    try {
      const json = JSON.parse(reader.result);
      fetch("/system/alert_thresholds/import", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(json)
      })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          alert(`✅ Imported ${res.updated} thresholds`);
          location.reload();
        } else {
          alert("❌ Import failed: " + res.error);
        }
      });
    } catch (e) {
      alert("❌ Invalid JSON: " + e.message);
    }
  };
  reader.readAsText(file);
}
</script>
{% endblock %}
